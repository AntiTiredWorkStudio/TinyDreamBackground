<?php
//引用此页面前需先引用conf.php
error_reporting(E_ALL ^ E_DEPRECATED);

LIB('db');
LIB('view');

class ContractManager extends DBManager{
    public function info()
    {
        echo json_encode(self::GetMonthList(PRC_TIME(),'CO0000000001'));
        return "ContractManager"; // TODO: Change the autogenerated stub
    }

	public function ContractManager(){
		
	}

	//计算日历(购买时间,合约ID)
	public static function GetMonthList($buyTime,$cid){
        $showtime=date("Y-m-d H:i:s", DAY_START_CELL($buyTime));
        $contract = self::GetContractInfo($cid);
        $startDayStamp = DAY_START_CELL($buyTime);
        $day = [];
        for($i = 0;$i<$contract['durnation'];$i++){
            $currentDayValue = $startDayStamp+86400*$i;
            $day[$i] = [
                'id'=>$i+1,
                'dateStamp' =>$currentDayValue,
                'date' => date("Y-m-d",$currentDayValue),
                'Year' => date("Y",$currentDayValue),
                'Month' => date("m",$currentDayValue),
                'Day' => date("d",$currentDayValue)
            ];
        }
        return  $day;
    }

	//获取合约主题列表
	public static function ThemeList(){
        return SnippetManager::GetAttributeFromData('OperationData','theme');
    }

    //通过合约id获取合约信息
	public static function GetContractInfo($cid){
        $COM = new ContractManager();
        return $COM->ContractInfo($cid)['contract'];
    }

	//获取合约类型表（信息）
	public function ContractList(){
        $backMsg = RESPONDINSTANCE('0');
        $result = DBResultToArray(
            $this->SelectDataByQuery($this->TName('tContract'),"1"),
            true
        );
        $backMsg['contracts'] = $result;
        $backMsg['themes'] = self::ThemeList();
        return $backMsg;
    }

    //通过合约id获取合约信息
    public function ContractInfo($cid){
        $backMsg = RESPONDINSTANCE('0');
        $result = DBResultToArray(
            $this->SelectDataByQuery($this->TName('tContract'),self::FieldIsValue('cid',$cid)),
            true
        );
        if(!empty($result)){
            $result = $result[0];
        }
        $backMsg['contract'] = $result;
        return $backMsg;
    }
}
?>